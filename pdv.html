<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Rápido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1ff; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .payment-input {
            border: 1px solid #D1D5DB; padding: 0.5rem 0.75rem; border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .payment-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="flex flex-col md:flex-row h-screen antialiased text-gray-800">

        <!-- Produtos -->
        <div class="flex-grow p-4 md:w-3/5 lg:w-2/3 flex flex-col">
            <header class="mb-4">
                <h1 class="text-3xl font-bold text-gray-900">Ponto de Venda</h1>
                <div class="relative mt-2">
                    <input type="text" id="search-input" placeholder="Buscar produto..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </header>
            
            <div id="loader" class="text-center py-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-lg text-gray-600">Carregando produtos...</p>
                <p id="error-message" class="text-red-500 mt-2 font-semibold"></p>
            </div>

            <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 overflow-y-auto custom-scrollbar flex-grow"></div>
        </div>

        <!-- Carrinho -->
        <div class="bg-white md:w-2/5 lg:w-1/3 p-4 flex flex-col shadow-lg md:border-l border-gray-200">
            <h2 class="text-2xl font-bold border-b pb-2 mb-4">Carrinho</h2>
            <div id="cart-items" class="flex-grow overflow-y-auto custom-scrollbar">
                <div id="empty-cart" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <svg class="w-16 h-16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <p class="mt-4 text-lg">Seu carrinho está vazio</p>
                </div>
            </div>
            <div class="mt-auto pt-4 border-t">
                <div class="flex justify-between items-center text-xl font-bold mb-4">
                    <span>Total:</span><span id="cart-total">R$ 0,00</span>
                </div>
                <button id="checkout-button" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 disabled:bg-blue-300 transition duration-300">Finalizar Venda</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-10">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6">Registrar Pagamento</h2>
            <div class="mb-4">
                <label for="client-name" class="block text-sm font-medium text-gray-700">Nome do Cliente (Opcional)</label>
                <input type="text" id="client-name" class="payment-input mt-1 block w-full" placeholder="Consumidor Final">
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label for="payment-pix" class="block text-sm font-medium text-gray-700">PIX</label><input type="number" id="payment-pix" class="payment-input mt-1 block w-full" placeholder="0,00" min="0" step="any"></div>
                <div><label for="payment-dinheiro" class="block text-sm font-medium text-gray-700">Dinheiro</label><input type="number" id="payment-dinheiro" class="payment-input mt-1 block w-full" placeholder="0,00" min="0" step="any"></div>
                <div><label for="payment-debito" class="block text-sm font-medium text-gray-700">Débito</label><input type="number" id="payment-debito" class="payment-input mt-1 block w-full" placeholder="0,00" min="0" step="any"></div>
                <div><label for="payment-credito" class="block text-sm font-medium text-gray-700">Crédito</label><input type="number" id="payment-credito" class="payment-input mt-1 block w-full" placeholder="0,00" min="0" step="any"></div>
                <div class="col-span-2"><label for="payment-caderneta" class="block text-sm font-medium text-gray-700">Caderneta (Fiado)</label><input type="number" id="payment-caderneta" class="payment-input mt-1 block w-full" placeholder="0,00" min="0" step="any"></div>
            </div>
            <div class="border-t pt-4 space-y-2 font-semibold">
                 <div class="flex justify-between items-center text-lg"><span>Total da Venda:</span><span id="payment-modal-total">R$ 0,00</span></div>
                 <div class="flex justify-between items-center text-lg text-green-600"><span>Total Pago:</span><span id="payment-modal-paid">R$ 0,00</span></div>
                 <div class="flex justify-between items-center text-lg text-red-600"><span>Restante:</span><span id="payment-modal-remaining">R$ 0,00</span></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                 <button onclick="closePaymentModal()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                 <button id="register-sale-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300">Registrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Recibo/Status -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-4">Venda Registrada!</h2>
            <div id="receipt-content" class="text-left mb-6 text-sm"></div>
            <div class="flex justify-between items-center text-lg font-bold mb-6">
                <span>Total Pago:</span><span id="receipt-total"></span>
            </div>
            <button id="receipt-close-button" class="w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-900">Nova Venda</button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // =================================================================================
        // CONFIGURAÇÃO DE PRODUTOS (LEITURA)
        // =================================================================================
        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPoSd228FqS9mWmxZeSzilvPWzueMVnwfe_i449uDOzhRKuAhn6nNCEkVXNiiIw41sgcbzY4tdME3v/pub?output=csv'; // <-- COLE A URL DA SUA PLANILHA DE PRODUTOS AQUI

        // =================================================================================
        // CONFIGURAÇÃO DE REGISTRO DE VENDAS (APPS SCRIPT)
        // Siga o arquivo instrucoes.md para obter esta URL.
        // Se não quiser registrar vendas, deixe este campo em branco.
        // =================================================================================
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbzr5Qop_drFdNo-ZDeynLbcCq3wz1ACB2i7mcjHf85XiiygSC-kI6hfKCP2WP-GVxc/exec'; // <-- COLE A URL DO SEU WEB APP DO GOOGLE APPS SCRIPT AQUI
        
        // Elementos da UI
        const productGrid = document.getElementById('product-grid');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const emptyCartEl = document.getElementById('empty-cart');
        const checkoutButton = document.getElementById('checkout-button');
        const searchInput = document.getElementById('search-input');
        const loader = document.getElementById('loader');
        const errorMessageEl = document.getElementById('error-message');
        
        // Modal de Pagamento
        const paymentModal = document.getElementById('payment-modal');
        const registerSaleButton = document.getElementById('register-sale-button');
        const paymentInputs = document.querySelectorAll('.payment-input');
        
        // Modal de Recibo
        const receiptModal = document.getElementById('receipt-modal');
        const receiptContent = document.getElementById('receipt-content');
        const receiptTotal = document.getElementById('receipt-total');
        const receiptCloseButton = document.getElementById('receipt-close-button');


        let allProducts = [];
        let cart = [];
        let currentTotal = 0;

        // --- Funções Principais ---
        
        function formatCurrency(value) {
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function fetchProducts() {
            if (!googleSheetUrl) {
                handleFetchError("URL da planilha de produtos não foi definida.");
                return;
            }
            Papa.parse(googleSheetUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const requiredFields = ['id', 'nome', 'preco'];
                    if (results.data.length > 0 && requiredFields.every(field => results.meta.fields.includes(field))) {
                        allProducts = results.data.map(p => ({
                            ...p, preco: parseFloat(p.preco.replace(',', '.'))
                        })).filter(p => p.id && p.nome && !isNaN(p.preco));
                        renderProducts(allProducts);
                        loader.style.display = 'none';
                    } else {
                        handleFetchError("A planilha de produtos está vazia ou os cabeçalhos (id, nome, preco) estão incorretos.");
                    }
                },
                error: (err) => {
                    handleFetchError("Não foi possível carregar os produtos. Verifique a URL e se a planilha está publicada corretamente.");
                    console.error("Erro ao buscar CSV:", err);
                }
            });
        }
        
        function handleFetchError(message) {
            loader.innerHTML = `<p class="text-red-500 font-bold">Erro ao carregar produtos.</p>`;
            errorMessageEl.innerText = message;
        }

        function renderProducts(productsToRender) {
            productGrid.innerHTML = '';
            if (productsToRender.length === 0) {
                 productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Nenhum produto encontrado.</p>`;
            }
            productsToRender.forEach(product => {
                const productEl = document.createElement('div');
                productEl.className = 'bg-white p-3 rounded-lg shadow-sm cursor-pointer hover:shadow-lg transition-shadow duration-200 flex flex-col justify-between';
                productEl.innerHTML = `<div class="flex-grow"><h3 class="font-semibold text-sm truncate">${product.nome}</h3></div><p class="font-bold text-lg mt-2">${formatCurrency(product.preco)}</p>`;
                productEl.addEventListener('click', () => addToCart(product.id));
                productGrid.appendChild(productEl);
            });
        }
        
        // --- Funções do Carrinho ---

        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) cartItem.quantity++;
            else cart.push({ ...product, quantity: 1 });
            updateCart();
        }

        function updateCart() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                emptyCartEl.style.display = 'flex';
                checkoutButton.disabled = true;
            } else {
                emptyCartEl.style.display = 'none';
                checkoutButton.disabled = false;
                cart.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center mb-3 p-2 bg-gray-50 rounded-md';
                    itemEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.nome}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(item.preco)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="quantity-change w-7 h-7 bg-gray-200 rounded-full font-bold text-lg hover:bg-gray-300" data-id="${item.id}" data-change="-1">-</button>
                            <span class="w-8 text-center font-medium">${item.quantity}</span>
                            <button class="quantity-change w-7 h-7 bg-gray-200 rounded-full font-bold text-lg hover:bg-gray-300" data-id="${item.id}" data-change="1">+</button>
                        </div>`;
                    cartItemsContainer.appendChild(itemEl);
                });
            }
            currentTotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
            cartTotalEl.textContent = formatCurrency(currentTotal);
        }

        // --- Funções do Modal de Pagamento ---

        window.openPaymentModal = function() {
            document.getElementById('payment-modal-total').textContent = formatCurrency(currentTotal);
            paymentInputs.forEach(input => input.value = '');
            document.getElementById('client-name').value = '';
            updatePaymentTotals();
            paymentModal.classList.remove('hidden');
            paymentModal.classList.add('flex');
        }

        window.closePaymentModal = function() {
            paymentModal.classList.add('hidden');
            paymentModal.classList.remove('flex');
        }

        function updatePaymentTotals() {
            let paidAmount = 0;
            paymentInputs.forEach(input => {
                if (input.type === 'number' && input.value) {
                    paidAmount += parseFloat(input.value);
                }
            });
            const remaining = currentTotal - paidAmount;
            
            document.getElementById('payment-modal-paid').textContent = formatCurrency(paidAmount);
            document.getElementById('payment-modal-remaining').textContent = formatCurrency(remaining > 0 ? remaining : 0);

            registerSaleButton.disabled = paidAmount < currentTotal;
        }

        async function registerSale() {
            if (!webAppUrl) {
                console.warn("URL do Web App não configurada. Exibindo recibo localmente.");
                showReceipt();
                closePaymentModal();
                return;
            }

            registerSaleButton.disabled = true;
            registerSaleButton.textContent = 'Registrando...';
            
            const saleData = {
                cliente: document.getElementById('client-name').value || 'Consumidor Final',
                pix: document.getElementById('payment-pix').value || 0,
                dinheiro: document.getElementById('payment-dinheiro').value || 0,
                debito: document.getElementById('payment-debito').value || 0,
                credito: document.getElementById('payment-credito').value || 0,
                caderneta: document.getElementById('payment-caderneta').value || 0,
                total: currentTotal.toFixed(2),
                itens: cart.map(item => `${item.quantity}x ${item.nome}`).join('; ')
            };

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(saleData),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Requerido pelo Apps Script
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    showReceipt();
                    closePaymentModal();
                } else {
                    showErrorModal('Falha no Registro', result.message);
                }

            } catch (error) {
                console.error('Erro de rede:', error);
                showErrorModal('Erro de Rede', 'Não foi possível conectar. Verifique a internet e a URL do Web App.');
            } finally {
                registerSaleButton.disabled = false;
                registerSaleButton.textContent = 'Registrar';
            }
        }
        
        // --- Funções do Recibo e Erro ---

        function showReceipt() {
            receiptModal.querySelector('h2').textContent = 'Venda Registrada!';
            receiptCloseButton.textContent = 'Nova Venda';
            receiptCloseButton.onclick = closeReceiptAndReset;
            receiptContent.innerHTML = cart.map(item => `<p class="flex justify-between"><span>${item.quantity}x ${item.nome}</span><span>${formatCurrency(item.preco * item.quantity)}</span></p>`).join('');
            receiptTotal.textContent = formatCurrency(currentTotal);
            receiptModal.classList.remove('hidden');
            receiptModal.classList.add('flex');
        }

        function showErrorModal(title, message) {
            receiptModal.querySelector('h2').textContent = title;
            receiptCloseButton.textContent = 'Tentar Novamente';
            receiptCloseButton.onclick = () => {
                receiptModal.classList.add('hidden');
                receiptModal.classList.remove('flex');
            };
            receiptContent.innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;
            receiptTotal.innerHTML = `<span class="text-red-500">FALHA</span>`;
            receiptModal.classList.remove('hidden');
            receiptModal.classList.add('flex');
        }

        function closeReceiptAndReset() {
            cart = [];
            updateCart();
            receiptModal.classList.add('hidden');
            receiptModal.classList.remove('flex');
        }

        // --- Event Listeners ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredProducts = allProducts.filter(p => p.nome.toLowerCase().includes(searchTerm));
            renderProducts(filteredProducts);
        });

        cartItemsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('quantity-change')) {
                const productId = e.target.dataset.id;
                const change = parseInt(e.target.dataset.change);
                const itemIndex = cart.findIndex(item => item.id === productId);
                if (itemIndex > -1) {
                    cart[itemIndex].quantity += change;
                    if (cart[itemIndex].quantity <= 0) cart.splice(itemIndex, 1);
                }
                updateCart();
            }
        });

        checkoutButton.addEventListener('click', () => {
            if (cart.length > 0) openPaymentModal();
        });

        paymentInputs.forEach(input => input.addEventListener('input', updatePaymentTotals));
        registerSaleButton.addEventListener('click', registerSale);
        receiptCloseButton.addEventListener('click', closeReceiptAndReset);

        // Iniciar a aplicação
        fetchProducts();
    });
    </script>
</body>
</html>

